<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>HPC SLURM</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../materials/06-dependencies.html" rel="next">
<link href="../materials/04-software.html" rel="prev">
<link href="../site_libs/quarto-contrib/quarto-project/cambiotraining/courseformat/img/university-of-cambridge-favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-fd4369bcce5669dc6f092a5d180a1716.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../site_libs/quarto-contrib/quarto-project/cambiotraining/courseformat/img/university_crest_reversed.png" alt="" class="navbar-logo light-content">
    <img src="../site_libs/quarto-contrib/quarto-project/cambiotraining/courseformat/img/university_crest_reversed.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Working on HPC Clusters using SLURM</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://docs.google.com/presentation/d/1KmnSznETddQdRYa6UAXtT-eMOsW7tEwbsOh0fK62c84/edit?usp=sharing"> 
<span class="menu-text">Slides</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/cambiotraining/hpc-intro"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:github" style="font-size: 1.25em;" aria-label="Icon github from fa6-brands Iconify.design set." title="CRIT GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/bioinfocambs.bsky.social"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:bluesky" style="font-size: 1.25em;" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="CRIT Bluesky"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://genomic.social/@BioInfoCambs"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:mastodon" style="font-size: 1.25em;" aria-label="Icon mastodon from fa6-brands Iconify.design set." title="CCRIT Mastodon"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bioinfotraining.bio.cam.ac.uk/"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="mdi:web" style="font-size: 1.25em;" aria-label="Icon web from mdi Iconify.design set." title="CCRIT Website"></iconify-icon></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Job Paralellisation</span></h1>
        </a>     
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Welcome</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data &amp; Setup</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Working on a HPC</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../materials/01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">HPC Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../materials/02-ssh.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Remote Work</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../materials/03-slurm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">SLURM Scheduler</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../materials/04-software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Software Management</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../materials/05-arrays.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Job Paralellisation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../materials/06-dependencies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Job Dependencies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../materials/07-files.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">File Transfer</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../materials/appendices/csd3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cambridge University HPC Resources</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../materials/appendices/slurm_cheatsheet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SLURM Quick Reference Guide</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#parallelising-tasks" id="toc-parallelising-tasks" class="nav-link active" data-scroll-target="#parallelising-tasks"><span class="header-section-number">7.1</span> Parallelising Tasks</a></li>
  <li><a href="#job-arrays" id="toc-job-arrays" class="nav-link" data-scroll-target="#job-arrays"><span class="header-section-number">7.2</span> Job Arrays</a>
  <ul class="collapse">
  <li><a href="#exercise-arrays-with-no-inputs" id="toc-exercise-arrays-with-no-inputs" class="nav-link" data-scroll-target="#exercise-arrays-with-no-inputs"><span class="header-section-number">7.2.1</span> Exercise: arrays with no inputs</a></li>
  </ul></li>
  <li><a href="#using-slurm_array_task_id-to-automate-jobs" id="toc-using-slurm_array_task_id-to-automate-jobs" class="nav-link" data-scroll-target="#using-slurm_array_task_id-to-automate-jobs"><span class="header-section-number">7.3</span> Using <code>$SLURM_ARRAY_TASK_ID</code> to Automate Jobs</a>
  <ul class="collapse">
  <li><a href="#exercise-arrays-with-multiple-inputs" id="toc-exercise-arrays-with-multiple-inputs" class="nav-link" data-scroll-target="#exercise-arrays-with-multiple-inputs"><span class="header-section-number">7.3.1</span> Exercise: arrays with multiple inputs</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">7.4</span> Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Job Paralellisation</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Learning Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Distinguish between different kinds of parallel computations: multi-threading within a job and job parallelisation across independent jobs.</li>
<li>Use SLURM <em>job arrays</em> to automatically submit several parallel jobs.</li>
<li>Customise each parallel job of an array to use different input -&gt; output.</li>
</ul>
</div>
</div>
<section id="parallelising-tasks" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="parallelising-tasks"><span class="header-section-number">7.1</span> Parallelising Tasks</h2>
<p>One of the important concepts in the use of a HPC is <strong>parallelisation</strong>. This concept is used in different ways, and can mean slightly different things.</p>
<p>A program may internally support parallel computation for some of its tasks, which we may refer to as <em>multi-threading</em> or <em>multi-core processing</em>. In this case, there is typically a single set of “input -&gt; output”, so all the parallel computations need to finish in order for us to obtain our result. In other words, there is some dependency between those parallel calculations.</p>
<p>On the other hand, we may want to run the same program on different inputs, where each run is completely independent from the previous run. In these cases we say the task is “embarrassingly parallel”. Usually, running tasks completely in parallel is faster, since we remove the need to keep track of what each task’s status is (since they are independent of each other).</p>
<p>Finally, we may want to do both things: run several jobs in parallel, while each of the jobs does some internal parallelisation of its computations (multi-threading).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/parallel.svg" class="img-fluid figure-img"></p>
<figcaption>Schematic of parallelisation.</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Terminology Alert!</strong></p>
<p>Some software packages have an option to specify how many CPU cores to use in their computations (i.e.&nbsp;they can parallelise their calculations). However, in their documentation this you may be referred to as <strong>cores</strong>, <strong>processors</strong>, <strong>CPUs</strong> or <strong>threads</strong>, which are used more or less interchangeably to essentially mean “how many calculations should I run in parallel?”. Although these terms are technically different, when you see this mentioned in the software’s documentation, usually you want to set it as the number of CPU cores you request from the cluster.</p>
</div>
</div>
</section>
<section id="job-arrays" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="job-arrays"><span class="header-section-number">7.2</span> Job Arrays</h2>
<p>There are several ways to parallelise jobs on a HPC. One of them is to use a built-in functionality in SLURM called <strong>job arrays</strong>.</p>
<p><em>Job arrays</em> are a collection of jobs that run in parallel with identical parameters. Any resources you request (e.g.&nbsp;<code>-c</code>, <code>--mem</code>, <code>-t</code>) apply to each individual job of the “array”. This means that you only need to submit one “master” job, making it easier to manage and automate your analysis using a single script.</p>
<p>Job arrays are created with the <em>SBATCH</em> option <code>-a START-FINISH</code> where <em>START</em> and <em>FINISH</em> are integers defining the range of array numbers created by SLURM. SLURM then creates a special shell variable <code>$SLURM_ARRAY_TASK_ID</code>, which contains the array number for the job being processed. Later in this section we will see how we can use some tricks with this variable to automate our analysis.</p>
<p>For now let’s go through this simple example, which shows what a job array looks like (you can find this script in the course folder <code>job_scripts/parallel_arrays.sh</code>):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ... some lines omitted ...</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH -o job_logs/parallel_arrays_%a.log</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH -a 1-3</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"This is task number </span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="st">"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Using </span><span class="va">$SLURM_CPUS_PER_TASK</span><span class="st"> CPUs"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Running on:"</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">hostname</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Submitting this script with <code>sbatch job_scripts/parallel_arrays.sh</code> will launch 3 jobs. The “<em>%a</em>” keyword is used in our output filename (<code>-o</code>) and will be replaced by the array number, so that we end up with three files: <code>parallel_arrays_1.log</code>, <code>parallel_arrays_2.log</code> and <code>parallel_arrays_3.log</code>. Looking at the output in those files should make it clearer that <code>$SLURM_ARRAY_TASK_ID</code> stores the array number of each job, and that each of them uses 2 CPUS (<code>-c 2</code> option). The compute node that they run on may be variable (depending on which node was available to run each job).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can define job array numbers in multiple ways, not just sequencially.</p>
<p>Here are some examples taken from SLURM’s Job Array Documentation:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 22%">
<col style="width: 77%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Option</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>-a 0-31</code></td>
<td style="text-align: left;">index values between 0 and 31</td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>-a 1,3,5,7</code></td>
<td style="text-align: left;">index values of 1, 3, 5 and 7</td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>-a 1-7:2</code></td>
<td style="text-align: left;">index values between 1 and 7 with a step size of 2 (i.e.&nbsp;1, 3, 5 and 7)</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="exercise-arrays-with-no-inputs" class="level3" data-number="7.2.1">
<h3 data-number="7.2.1" class="anchored" data-anchor-id="exercise-arrays-with-no-inputs"><span class="header-section-number">7.2.1</span> Exercise: arrays with no inputs</h3>
<div class="callout callout-style-default callout-exercise no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Exercise</span>Exercise 1
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<div class="callout-exercise">
<p>Before starting this exercise:</p>
<ul>
<li>Make sure you are in the workshop folder (<code>cd ~/rds/hpc-work/hpc_workshop</code>).</li>
<li>Activate a software environment needed for the exercise (we will cover the details in the <a href="../materials/04-software.html">Software Management</a> chapter): <code>mamba activate base</code>
<ul>
<li>Your prompt should now start with the prefix <code>(base)</code></li>
</ul></li>
</ul>
<p>Previously, we used the <code>pi_estimator.R</code> script to obtain a single estimate of the number Pi. Since this is done using a stochastic algorithm, we may want to run it several times to get a sense of the error associated with our estimate.</p>
<ol type="1">
<li>Use <em>Nano</em> to open the SLURM submission script in <code>job_scripts/parallel_estimate_pi.sh</code>. Adjust the <code>#SBATCH</code> options (where word “FIXME” appears), to run the job 10 times using a job array.</li>
<li>Launch the job with <code>sbatch</code>, monitor its progress and examine the output.</li>
<li>Bonus: combine all the output files into a single file. Should you run this operation directly on the login node, or submit it as a new job to SLURM?</li>
</ol>
<div class="callout callout-style-default callout-hint no-icon callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Hint</span>Hint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="callout-hint">
<p>Note that the output of <code>pi_estimator.R</code> is now being sent to individual text files to the directory <code>results/pi/</code>.</p>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-answer no-icon callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Answer</span>Answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="callout-answer">
<p><strong>A1.</strong></p>
<p>In our script, we need to add <code>#SBATCH -a 1-10</code> as one of our options, so that when we submit this script to <code>sbatch</code>, it will run 10 iterations of it in parallel.</p>
<p>Also, remember to edit SLURM’s working directory with your username, at the top of the script in the <code>#SBATCH -D</code> option.</p>
<p><strong>A2.</strong></p>
<p>We can launch our adjusted script with <code>sbatch job_scripts/parallel_estimate_pi.sh</code>. When we check our jobs with <code>squeue -u USERNAME</code>, we will notice several jobs with JOBID in the format “ID_1”, “ID_2”, etc. These indicate the number of the array that is currently running as part of that job submission.</p>
<p>In this case, we will get 10 output log files, each with the job array number at the end of the filename (we used the <code>%a</code> keyword in the <code>#SBATCH -o</code> option to achieve this).</p>
<p>The 10 separate estimates of Pi were written to separate text files named <code>results/pi_estimate_1.txt</code>, <code>results/pi_estimate_2.txt</code>, etc.</p>
<p><strong>A3.</strong></p>
<p>To combine the results of these 10 replicate runs of our Pi estimate, we could use the Unix tool <code>cat</code>:</p>
<p><code>cat results/pi/replicate_*.txt &gt; results/pi/combined_estimates.txt</code></p>
<p>If we examine this file (e.g.&nbsp;with <code>less results/combined_estimates.txt</code>) we can see it has the results of all the runs of our simulation.</p>
<p>This <code>cat</code> operation is not computationally demanding at all, so it makes sense to run it from the login node. In fact, submitting it to the scheduler would not be an efficient use of it.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="using-slurm_array_task_id-to-automate-jobs" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="using-slurm_array_task_id-to-automate-jobs"><span class="header-section-number">7.3</span> Using <code>$SLURM_ARRAY_TASK_ID</code> to Automate Jobs</h2>
<p>One way to automate our jobs is to use the job array number (stored in the <code>$SLURM_ARRAY_TASK_ID</code> variable) with some command-line tricks. The trick we will demonstrate here is to parse a CSV file to read input parameters for our scripts.</p>
<p>For example, in our <code>data/</code> folder we have the following file, which includes information about parameter values we want to use with a tool in our next exercise.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat data/turing_model_parameters.csv</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>f,k
0.055,0.062
0.03,0.055
0.046,0.065
0.059,0.061</code></pre>
<p>This is a CSV (comma-separated values) format, with two “columns” named “f” and “k”. Let’s say we wanted to obtain information for the 2rd set of parameters, which in this case is in the 3rd line of the file (because of the column header). We can get the top N lines of a file using the <code>head</code> command (we pipe the output of the previous <code>cat</code> command):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat data/turing_model_parameters.csv <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 3</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This gets us lines 1-3 of the file. To get just the information about that 2nd set of parameters, we can now <em>pipe</em> the output of the <code>head</code> command to the command that gets us the bottom lines of a file <code>tail</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat data/turing_model_parameters.csv <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 3 <span class="kw">|</span> <span class="fu">tail</span> <span class="at">-n</span> 1</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Finally, to separate the two values that are separated by a comma, we can use the <code>cut</code> command, which accepts a <em>delimiter</em> (<code>-d</code> option) and a <em>field</em> we want it to return (<code>-f</code> option):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat data/turing_model_parameters.csv <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 3 <span class="kw">|</span> <span class="fu">tail</span> <span class="at">-n</span> 1 <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span> <span class="st">","</span> <span class="at">-f</span> 1</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>In this example, we use comma as a delimiter field and obtained the first of the values after “cutting” that line.</p>
<p>Schematically, this is what we’ve done:</p>
<p><img src="images/head_tail.png" class="img-fluid"></p>
<p>So, if we wanted to use job arrays to automatically retrieve the relevant line of this file as its input, we could use <code>head -n $SLURM_ARRAY_TASK_ID</code> in our command pipe above. Let’s see this in practice in our next exercise.</p>
<section id="exercise-arrays-with-multiple-inputs" class="level3" data-number="7.3.1">
<h3 data-number="7.3.1" class="anchored" data-anchor-id="exercise-arrays-with-multiple-inputs"><span class="header-section-number">7.3.1</span> Exercise: arrays with multiple inputs</h3>
<div class="callout callout-style-default callout-exercise no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Exercise</span>Exercise 2
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<div class="callout-exercise">
<p>This exercise is composed of two equivalent sub-exercises.</p>
<p>One exemplifies how to automate a common bioinformatics task of mapping sequencing reads to a reference genome. It is suitable for life scientists who may want to go through a bioinformatics-flavoured example.</p>
<p>The other exercise uses a more generic simulation script, which takes as input two parameters that determine the simulation outcome. If it’s any motivation, this version of the exercise produces pretty pictures as an output. :)</p>
<p>You can choose one of the two to start with (whichever one suits your work better), and then do the other one if you also have time.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Bioinformatics</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Simulation</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>Make sure you are in the workshop folder (<code>cd ~/rds/hpc-work/hpc_workshop</code>).</p>
<p>Continuing from our previous exercise where we <a href="04-software.html#Loading_Conda_Environments">prepared our <em>Drosophila</em> genome for bowtie2</a>, we now want to map each of our samples’ sequence data to the reference genome.</p>
<p><img src="images/mapping.png" class="img-fluid" style="width:50.0%"></p>
<p>Looking at our data directory (<code>ls hpc_workshop/data/reads</code>), we can see several sequence files in standard <em>fastq</em> format. These files come in pairs (with suffix “_1” and “_2”), and we have 8 different samples. Ideally we want to process these samples in parallel in an automated way.</p>
<p>We have created a CSV file with three columns. One column contains the sample’s name (which we will use for our output files) and the other two columns contain the path to the first and second pairs of the input files. With the information on this table, we should be able to automate our data processing using a SLURM job array.</p>
<ol type="1">
<li>Use <em>Nano</em> to open the SLURM submission script in <code>job_scripts/parallel_drosophila_mapping.sh</code>. The first few lines of the code are used to fetch parameter values from the CSV file:
<ul>
<li>Fix your username in <code>#SBATCH -D</code>.</li>
<li>Fix the <code>#SBATCH -a</code> option - this array should have as many jobs as we have samples in our CSV samplesheet.</li>
<li>Fix the <code>head</code> command further down the script. This command intends to fetch each line from the CSV samplesheet using the <code>$SLURM_ARRAY_TASK_ID</code> variable.</li>
</ul></li>
<li>Launch the job with <code>sbatch</code> and monitor its progress (<code>squeue</code>), whether it runs successfully (<code>scontrol show job JOBID</code> or <code>seff JOBID</code>), and examine the SLURM output log files.</li>
<li>Check if you got the expected output files in the <code>results/drosophila/mapping</code> folder. (Note: the output files are text-based in a standard bioinformatics format called <a href="https://en.wikipedia.org/wiki/SAM_(file_format)">SAM</a>.)</li>
</ol>
<p>Study the submission script to see if you understand the code - and ask the trainers for clarifications if you are unfamiliar with some of the code we used.</p>
<div class="callout callout-style-default callout-answer no-icon callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Answer</span>Answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="callout-answer">
<p><strong>A1.</strong></p>
<p>We fixed the code in three places:</p>
<ul>
<li>As usual, we fixed the <code>#SBATCH -D</code> option to point to our home directory in the cluster.</li>
<li>We fixed the <code>#SBATCH -a</code> option - this array should have as many jobs as we have samples in our CSV samplesheet. We used <code>#SBATCH -a 2-9</code>:
<ul>
<li>Starting at 2, because the parameter values start at the second line of the parameter file. And finishing at 9, because that’s the number of lines in the CSV file.</li>
</ul></li>
<li>We also fixed the <code>head</code> command further down the script. This command intends to fetch each line from the CSV parameters file, using the <code>$SLURM_ARRAY_TASK_ID</code> variable.
<ul>
<li>We changed <code>head -n FIXME</code> to <code>head -n $SLURM_ARRAY_TASK_ID</code>, so that each job of the array fetches its corresponding line from the CSV file.</li>
</ul></li>
</ul>
<p><strong>A2.</strong></p>
<p>We can submit the script with <code>sbatch job_scripts/parallel_drosophila_mapping.sh</code>. While the job is running we can monitor its status with <code>squeue -u USERNAME</code>. We should see several jobs listed with IDs as <code>JOBID_ARRAYID</code> format.</p>
<p>Because we used the <code>%a</code> keyword in our <code>#SBATCH -o</code> option, we will have an output log file for each job of the array. We can list these log files with <code>ls job_logs/parallel_drosophila_mapping_*.log</code> (using the “*” wildcard to match any character). If we examine the content of one of these files (e.g.&nbsp;<code>cat job_logs/parallel_drosophila_mapping_1.log</code>), we should only see the messages we printed with the <code>echo</code> commands. The actual output of the <code>bowtie2</code> program is a file in [SAM](https://en.wikipedia.org/wiki/SAM_(file_format) format, which is saved into the <code>results/drosophila/mapping</code> folder.</p>
<p><strong>A3.</strong></p>
<p>Once all the array jobs finish, we should have 8 SAM files in <code>ls results/drosophila/mapping</code>. We can examine the content of these files, although they are not terribly useful by themselves. In a typical bioinformatics workflow these files would be used for further analysis, for example SNP-calling.</p>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>Make sure you are in the workshop folder (<code>cd ~/rds/hpc-work/hpc_workshop</code>).</p>
<p>A PhD student is working on project to understand how different patterns, such as animal stripes and coral colonies, form in nature. They are using a type of model, first proposed by <a href="https://en.wikipedia.org/wiki/Turing_pattern">Alan Turing</a>, which models the interaction between two components that can difuse in space and promote/inhibit each other.</p>
<details>
<summary>
Click for more about this model
</summary>
<p>Turing patterns can be generated with a type of mathematical model called a “Reaction-diffusion system”. It models two substances - A and B - that can difuse in space and interact with each other in the following way: substance A self-activates and also activates B, while B inhibits A.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://ars.els-cdn.com/content/image/3-s2.0-B9780123821904000061-f06-05-9780123821904.jpg" class="img-fluid figure-img"></p>
<figcaption>https://doi.org/10.1016/B978-0-12-382190-4.00006-1</figcaption>
</figure>
</div>
<p>This seemingly simple interaction can generate complex spatial patterns, some of which capture the diversity of patterns observed in nature. Here is a very friendly video illustrating this: https://youtu.be/alH3yc6tX98</p>
</details>
<p>The student has a python script that runs this model taking some input parameters and outputs an image file with the final result of the model. The two main parameters in the model are called “feed” and “kill”, and their python script accepts these as options, for example:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> analysis_scripts/turing_pattern.py <span class="at">--feed</span> 0.04 <span class="at">--kill</span> 0.06 <span class="at">--outdir</span> results/turing/</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This would produce an image saved as <code>results/turing/f0.04_k0.06.png</code>.</p>
<p>The student has been running this script on their laptop, but it takes a while to run and they would like to try several parameter combinations. They have prepared a CSV file in <code>data/turing_model_parameters.csv</code> with parameter values of interest (you can look at the content of this file using <code>cat</code>).</p>
<p>Our objective is to automate running these models in parallel on the HPC.</p>
<ol type="1">
<li>Use <em>Nano</em> to open the SLURM submission script in <code>job_scripts/parallel_turing_pattern.sh</code>. The first few lines of the code are used to fetch parameter values from the CSV file:
<ul>
<li>Fix your username in <code>#SBATCH -D</code>.</li>
<li>Fix the <code>#SBATCH -a</code> option - this array should have as many jobs as we have parameter combinations in our CSV file.</li>
<li>Fix the <code>head</code> command further down the script. This command intends to fetch each line from the CSV parameters file, using the <code>$SLURM_ARRAY_TASK_ID</code> variable.</li>
</ul></li>
<li>Launch the job with <code>sbatch</code> and monitor its progress (<code>squeue</code>), whether it runs successfully (<code>scontrol show job JOBID</code> or <code>seff JOBID</code>), and examine the SLURM output log files.</li>
<li>Examine the output files in the <code>results/turing/</code> folder. You should have several PNG files. These cannot be easily viewed on the HPC, but you can transfer them to your computer using <em>Filezilla</em> or the command-line (<code>scp</code> or <code>rsync</code>), as will be covered in the <a href="../materials/07-files.html">File Transfer</a> section.</li>
</ol>
<div class="callout callout-style-default callout-hint no-icon callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Hint</span>Hint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="callout-hint">
<p>The array should have as many numbers as there are lines in our CSV file. However, make sure the array number starts at 2 because the CSV file has a header with column names.</p>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-answer no-icon callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Answer</span>Answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="callout-answer">
<p><strong>A1.</strong></p>
<p>We fixed the code in three places:</p>
<ul>
<li>As usual, we fixed the <code>#SBATCH -D</code> option to point to our home directory in the cluster.</li>
<li>We fixed the <code>#SBATCH -a</code> option - this array should have as many jobs as we have simulation parameters in our CSV samplesheet. We used <code>#SBATCH -a 2-5</code>:
<ul>
<li>Starting at 2, because the parameter values start at the second line of the parameter file. And finishing at 5, because that’s the number of lines in the CSV file.</li>
</ul></li>
<li>We also fixed the <code>head</code> command further down the script. This command intends to fetch each line from the CSV parameters file, using the <code>$SLURM_ARRAY_TASK_ID</code> variable.
<ul>
<li>We changed <code>head -n FIXME</code> to <code>head -n $SLURM_ARRAY_TASK_ID</code>, so that each job of the array fetches its corresponding line from the CSV file.</li>
</ul></li>
</ul>
<p><strong>A2.</strong></p>
<p>We can submit the script with <code>sbatch job_scripts/parallel_turing_pattern.sh</code>. While the job is running we can monitor its status with <code>squeue -u USERNAME</code>. We should see several jobs listed with IDs as <code>JOBID_ARRAYID</code> format.</p>
<p>Because we used the <code>%a</code> keyword in our <code>#SBATCH -o</code> option, we will have an output log file for each job of the array. We can list these log files with <code>ls job_logs/parallel_turing_pattern_*.log</code> (using the “*” wildcard to match any character). If we examine the content of one of these files (e.g.&nbsp;<code>cat job_logs/parallel_turing_pattern_1.log</code>), we should only see the messages we printed with the <code>echo</code> commands. The actual output of the python script is an image, which is saved into the <code>results/turing</code> folder.</p>
<p><strong>A3.</strong></p>
<p>Once all the array jobs finish, we should have 5 image files in <code>ls results/turing</code>:</p>
<pre><code>f0.03_k0.055.png  f0.046_k0.065.png  f0.055_k0.062.png  f0.059_k0.061.png</code></pre>
<p>As these are images, they cannot be viewed on the HPC. Instead, we can move these files to our computer as will be covered in the <a href="../materials/07-files.html">File Transfer</a> section.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="summary"><span class="header-section-number">7.4</span> Summary</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Key Points
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Some tools internally parallelise some of their computations, which is usually referred to as <em>multi-threading</em> or <em>multi-core processing</em>.</li>
<li>When computational tasks are independent of each other, we can use job parallelisation to make them more efficient.</li>
<li>We can automatically generate parallel jobs using SLURM job arrays with the <code>sbatch</code> option <code>-a</code>.</li>
<li>SLURM creates a variable called <code>$SLURM_ARRAY_TASK_ID</code>, which can be used to customise each individual job of the array.
<ul>
<li>For example we can obtain the input/output information from a simple configuration text file using some command line tricks: <code>cat config.csv | head -n $SLURM_ARRAY_TASK_ID | tail -n 1</code></li>
</ul></li>
</ul>
<p>Further resources:</p>
<ul>
<li><a href="https://slurm.schedmd.com/job_array.html">SLURM Job Array Documentation</a></li>
</ul>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../materials/04-software.html" class="pagination-link" aria-label="Software Management">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Software Management</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../materials/06-dependencies.html" class="pagination-link" aria-label="Job Dependencies">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Job Dependencies</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Licensed <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> <img src="https://creativecommons.org/images/deed/cc_icon_black_x2.png" class="img-fluid" width="25"> Cambridge Research Informatics Training</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>